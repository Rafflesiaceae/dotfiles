#!/bin/bash
set -eo pipefail

echo {{{1 record itself
if [[ "$1" != "--no-record" ]]; then
    title=".update_arch_$(date +%s)"
    echo "recording output to $HOME/$title.cast"
    asciinema rec \
        --command "\"$0\" --no-record" \
        --title "$title" \
        --quiet \
        "$HOME/$title.cast"
    exit 0
fi

echo {{{1 update official packages
sudo pacman -Syu --noconfirm

echo {{{1 update yay
tput bel # ring-bell
aurloc="$HOME/.aur"
mkdir -p "$aurloc"
mkdir -p "$aurloc/yay"
pushd "$aurloc/yay"
wget "https://aur.archlinux.org/cgit/aur.git/snapshot/yay.tar.gz"
tar xvfz "yay.tar.gz" -C ../
makepkg -i --noconfirm --needed --skippgpcheck
popd

echo {{{1 update some AUR packages
tput bel # ring-bell
yay -S --answerdiff "None" --answerclean "None" \
    deadbeef-git

echo {{{1 update vim plugins
nvim +'PlugUpdate --sync' +qa

echo {{{1 update amr
amrloc="$HOME/.amr"
[[ ! -d "$amrloc" ]] && git clone "https://github.com/Rafflesiaceae/pkgbuilds.git" "$amrloc"
pushd "$amrloc"
git pull

makepkg-and-install() {
    pushd "$1"
    if [[ "$2" == "force" ]]; then
        makepkg -i --noconfirm --force
    else
        makepkg -i --noconfirm --needed
    fi
    popd
}

makepkg-and-install "rxvt-unicode-patched"  "force" # needs recompilation when perl updates
makepkg-and-install "xkeyboard-config-desc"

popd

echo {{{1 update YCM
pushd "$HOME/.vim/plugged/YouCompleteMe"
./install.py \
    --clangd-completer \
    --go-completer \
    --java-completer \
    --rust-completer \
    --ts-completer
popd

echo "CONSIDER RESTARTING!"
