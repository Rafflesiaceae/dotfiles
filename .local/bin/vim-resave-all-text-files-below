#!/usr/bin/env bash
set -euo pipefail

echo "gathering files..."

tmpfile="$(mktemp)"
vimscr="$(mktemp)"
trap 'rm -f "$tmpfile" "$vimscr"' EXIT

find-all-text-files >"$tmpfile"

if ! [ -s "$tmpfile" ]; then
  echo "no files found"
  exit 0
fi

echo "resaving..."

cat >"$vimscr" <<'VIM'
set nomore
set noswapfile
set shortmess+=I

let fl = getenv('FILELIST')
if empty(fl)
  call writefile(['ERROR: FILELIST env var is empty'], '/dev/fd/2', 'a')
  qa!
endif

for f in readfile(fl)
  if empty(f) | continue | endif
  try
    execute 'edit' fnameescape(f)

    " Force a write even if nothing appears changed
    let &l:modified = 1
    write!

    " progress
    call writefile([expand('%:p')], '/dev/fd/1', 'a')
  catch
    call writefile(['ERROR ' . f . ': ' . v:exception], '/dev/fd/2', 'a')
  endtry
endfor

qa!
VIM

FILELIST="$tmpfile" nvim --headless -S "$vimscr"
