#!/usr/bin/env bash
set -eo pipefail

set -x
echo "gathering files..."

# Create temp file and make sure we clean it up
tmpfile="$(mktemp)"
trap 'rm -f "$tmpfile"' EXIT

# Fill temp file with the list of files
find-all-text-files >"$tmpfile"

# Nothing to do?
if ! [ -s "$tmpfile" ]; then
    echo "no files found"
    exit 0
fi

echo "resaving..."

# FILELIST="$tmpfile" vim -Es <<'EOF'
# set nomore
# echom expand('%:p')
# echo 'JKSAD'
# echom 'oiquwe'
# EOF

# Pass the path via env var so Vim can read it
FILELIST="$tmpfile" vim -Es <<'EOF'
set nomore

let fl = $FILELIST
if empty(fl)
  qall
endif

" Where to print progress lines (POSIX systems)
let out = '/dev/stdout'

" Read the file list (one filename per line)
for f in readfile(fl)
  if empty(f)
    continue
  endif

  " Open file, let editorconfig/etc do its thing
  execute 'edit' fnameescape(f)

  " Write file (triggers BufWrite hooks, editorconfig, etc.)
  silent! write

  " Print absolute path of the file just written
  call writefile([expand('%:p')], out, 'a')
endfor

qall
EOF
