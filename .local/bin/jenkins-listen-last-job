#!/usr/bin/env python3
# [RUN] ./% "https://jenkins-staging.rnd.ims.co.at/job/code-review-pipeline/job/main-gerrit_commands/"
import json
import subprocess
import sys

from subprocess import PIPE,DEVNULL,STDOUT

def sh(*args, check=True, timeout=None, shell=False, **kwargs):
    if shell: args = args[0]
    cp = subprocess.run(args, stdout=PIPE, check=check, timeout=timeout, shell=shell, **kwargs)
    return cp.stdout.decode(), cp

def secret_lookup():
    return sh()[0]

def get_job(url):
    print(url)
    return json.loads(sh(
        "curl", "-X", "GET", "-L", "--user",
        sh("secret-lookup", "ims.jenkins-staging.username")[0]+":"+
        sh("secret-lookup", "ims.jenkins-staging.password")[0],
        "--silent",
        url
    )[0])

def main():
    args=sys.argv[1:]
    url=args[0]
    lastBuildUrl=f"{url}/lastBuild/api/json"
    ret = get_job(lastBuildUrl)
    print(ret["id"])

if __name__ == "__main__":
    main()
